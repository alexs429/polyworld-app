<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polyworld · Ember Training</title>
  <style>
    :root {
      --bg:#0b0f14; --panel:#111824; --panel-2:#0e1520; --text:#e6f0ff; --muted:#9bb0c9;
      --brand:#6ad2ff; --accent:#ffb84d; --ok:#7dffbd; --danger:#ff6a7a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial; color:var(--text); background:radial-gradient(1200px 600px at 70% 10%, #122030, var(--bg));
      overflow-x:hidden;
    }
    a{color:var(--brand); text-decoration:none}

    /* Header */
    .hdr{position:sticky; top:0; z-index:50; display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:linear-gradient(180deg, rgba(10,14,20,.9), rgba(10,14,20,.6)); backdrop-filter: blur(8px); border-bottom:1px solid rgba(255,255,255,.06)}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:28px; height:28px; border-radius:50%; background:conic-gradient(from 220deg, #ff7a18, #ffd56a, #6ad2ff, #7dffbd, #ff7a18); box-shadow:0 0 24px #ff7a18aa}
    .nav{display:flex; gap:14px; opacity:.9}
    .wallet{display:flex; gap:10px; align-items:center}
    .chip{border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:999px; background:linear-gradient(180deg, #141c27, #0e1520); font-size:12px}
    .btn{cursor:pointer; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, #1a2432, #121a28); color:var(--text); padding:8px 12px; border-radius:10px; transition:transform .08s ease, box-shadow .2s;}
    .btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04)}

    /* Hero Scene */
    .hero{position:relative; height:58vh; min-height:520px; display:grid; place-items:center;}
    .scene{position:relative; width:min(1200px, 92vw); height:100%;}
    canvas#embers{position:absolute; inset:0; z-index:0}
    .title{position:absolute; top:24px; left:24px; z-index:2;}
    .title h1{margin:0 0 6px; font-weight:700; letter-spacing:.3px}
    .title p{margin:0; color:var(--muted)}

    /* Couches + Avatars */
    .couch{position:absolute; width:200px; height:90px; background:linear-gradient(180deg, #1e2a3a, #141c22); border:1px solid rgba(255,255,255,.08); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.45); display:grid; place-items:center; overflow:hidden}
    .couch::after{content:""; position:absolute; inset:0; background:radial-gradient(200px 80px at 50% 120%, rgba(255,184,77,.25), transparent 60%); opacity:.4}
    .avatar{width:66px; height:66px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffd56a, #ff7a18 50%, rgba(255,122,24,.5)); filter: drop-shadow(0 0 12px rgba(255,184,77,.6)); animation:float 4s ease-in-out infinite}
    .avatar.ember{background:radial-gradient(circle at 30% 30%, #6ad2ff, #7a53ff 55%, rgba(106,210,255,.5)); filter: drop-shadow(0 0 12px rgba(106,210,255,.6))}
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }

    .couch .label{position:absolute; bottom:8px; font-size:12px; color:#cfe3ffcc}
    .couch:hover{outline:1px solid rgba(255,255,255,.18); transform:translateY(-2px); cursor:pointer}

    /* Layout positions (arc) */
    .couch.flame{left:50%; top:48%; transform:translate(-50%,-50%)}
    .couch.e1{left:18%; top:62%}
    .couch.e2{left:50%; top:70%; transform:translateX(-50%)}
    .couch.e3{right:18%; top:62%}

    /* Training Drawer */
    .drawer{position:fixed; left:0; right:0; bottom:-60vh; height:60vh; background:linear-gradient(180deg, #0f1623, #0a1018); border-top:1px solid rgba(255,255,255,.08); box-shadow:0 -20px 60px rgba(0,0,0,.5); transition:bottom .36s cubic-bezier(.2,.9,.2,1); z-index:60}
    .drawer.open{bottom:0}
    .drawer .bar{display:flex; align-items:center; justify-content:space-between; padding:10px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .drawer .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; padding:14px; height:calc(60vh - 52px)}
    .panel{background:linear-gradient(180deg, #121a28, #0d1522); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; overflow:hidden}

    .chat{display:flex; flex-direction:column; height:100%}
    .msgs{flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; padding-right:6px}
    .msg{max-width:80%; padding:10px 12px; border-radius:12px; font-size:14px; line-height:1.35}
    .msg.user{align-self:flex-end; background:#1b2a3f}
    .msg.ember{align-self:flex-start; background:#172335}
    .inputrow{display:flex; gap:8px; margin-top:10px}
    .inputrow input{flex:1; padding:10px 12px; border-radius:10px; background:#0d1420; border:1px solid rgba(255,255,255,.12); color:var(--text)}

    .side{display:grid; gap:10px}
    .kv{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:10px; background:#0d1420; border:1px solid rgba(255,255,255,.08)}
    .meter{height:10px; background:#0d1420; border:1px solid rgba(255,255,255,.1); border-radius:999px; overflow:hidden}
    .meter > i{display:block; height:100%; width:30%; background:linear-gradient(90deg, var(--accent), #ffd56a)}

    /* Upload */
    .uploader{border:1px dashed rgba(255,255,255,.15); border-radius:12px; padding:14px; text-align:center}

    /* Footer */
    footer{padding:30px 16px; color:var(--muted)}

    /* Responsive */
    @media (max-width: 980px){
      .couch{width:160px}
      .drawer .grid{grid-template-columns:1fr; height:auto}
      .drawer{height:72vh}
      .msgs{max-height:34vh}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="hdr">
    <div class="brand">
      <div class="logo"></div>
      <strong>Polyworld</strong>
      <nav class="nav">
        <a href="#">Home</a>
        <a href="#">Embers</a>
        <a href="#" aria-current="page">Training</a>
        <a href="#">Account</a>
      </nav>
    </div>
    <div class="wallet">
      <span id="walletChip" class="chip">Not connected</span>
      <span id="balChip" class="chip" title="POLISTAR balance">POLISTAR: —</span>
      <button class="btn" id="connectBtn">Connect Wallet</button>
    </div>
  </header>

  <!-- Hero / Scene -->
  <section class="hero">
    <div class="scene">
      <div class="title">
        <h1>Raise Your Ember</h1>
        <p>Train an AI being with your tone, knowledge, and presence. Select an Ember couch to begin.</p>
      </div>
      <canvas id="embers"></canvas>

      <!-- Flame (human coach) -->
      <div class="couch flame" id="flameCouch" aria-label="Flame coach">
        <div class="avatar" title="Flame"></div>
        <div class="label">Flame</div>
      </div>

      <!-- Ember couches -->
      <div class="couch e1" data-ember="alpha">
        <div class="avatar ember" title="Ember α"></div>
        <div class="label">Ember α</div>
      </div>
      <div class="couch e2" data-ember="beta">
        <div class="avatar ember" title="Ember β"></div>
        <div class="label">Ember β</div>
      </div>
      <div class="couch e3" data-ember="gamma">
        <div class="avatar ember" title="Ember γ"></div>
        <div class="label">Ember γ</div>
      </div>
    </div>
  </section>

  <!-- Training Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="bar">
      <div style="display:flex; align-items:center; gap:10px">
        <strong id="drawerTitle">Training · Ember</strong>
        <span id="timer" class="chip" title="Remaining time">00:30:00</span>
        <span id="cost" class="chip" title="Cost per session">Cost: 50 POLISTAR / 30min</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="saveBtn">Save Summary</button>
        <button class="btn" id="endBtn">End</button>
      </div>
    </div>
    <div class="grid">
      <!-- Chat panel -->
      <div class="panel chat">
        <div id="msgs" class="msgs" aria-live="polite"></div>
        <div class="inputrow">
          <input id="chatInput" placeholder="Teach your Ember… (tone, stories, rules)" />
          <button class="btn" id="sendBtn">Send</button>
        </div>
      </div>

      <!-- Side controls -->
      <div class="panel side">
        <div class="kv"><span>Selected Ember</span><strong id="emberName">—</strong></div>
        <div class="kv"><span>Your POLISTAR</span><strong id="polistarBal">—</strong></div>
        <div class="kv"><span>Session Length</span><strong id="len">30 min</strong></div>
        <div>
          <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted)"><span>Session Progress</span><span id="progressPct">0%</span></div>
          <div class="meter"><i id="meterBar"></i></div>
        </div>
        <div class="uploader" id="uploader">
          <div><strong>Drop files</strong> (PDF/TXT/MD) to add teachings</div>
          <div style="font-size:12px; color:var(--muted); margin-top:6px">They'll be summarized and indexed into your Ember's Data Store.</div>
        </div>
        <button class="btn" id="importBtn">Import Past Chats</button>
      </div>
    </div>
  </aside>

  <footer>
    Powered by Polyworld · Sessions secured by blockchain · Dialogflow CX + Data Stores for RAG
  </footer>

  <script>
    // ===== Scene particle background (lightweight) =====
    const cvs = document.getElementById('embers');
    const ctx = cvs.getContext('2d');
    let particles = [];
    function resize(){
      cvs.width = cvs.parentElement.clientWidth; cvs.height = cvs.parentElement.clientHeight;
    }
    window.addEventListener('resize', resize); resize();
    function spawn(n=80){
      particles = Array.from({length:n}, ()=>({
        x: Math.random()*cvs.width,
        y: Math.random()*cvs.height,
        r: Math.random()*2+0.6,
        a: Math.random()*Math.PI*2,
        s: 0.2+Math.random()*0.8,
      }));
    }
    spawn();
    function tick(){
      ctx.clearRect(0,0,cvs.width,cvs.height);
      for(const p of particles){
        p.a += 0.01*p.s; p.y -= 0.3*p.s; if(p.y < -10){ p.y = cvs.height+10; p.x = Math.random()*cvs.width; }
        const glow = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*8);
        glow.addColorStop(0,'rgba(255,184,77,.35)');
        glow.addColorStop(1,'rgba(255,184,77,0)');
        ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(p.x,p.y,p.r*8,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255,184,77,.8)'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      }
      requestAnimationFrame(tick);
    }
    tick();

    // ===== Wallet + balances (stubs to integrate) =====
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.addEventListener('click', connectWallet);
    async function connectWallet(){
      try{
        if(!window.ethereum){ alert('MetaMask not detected'); return; }
        const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
        const address = accounts[0];
        document.getElementById('walletChip').textContent = short(address);
        // TODO: call your authenticateMetamask function & then get balances
        // const res = await fetch('https://us-central1-poliworld-f165b.cloudfunctions.net/getPolistarBalance',{...})
        updatePolistarUI(0);
      }catch(e){ console.error(e); }
    }
    const short = (a)=> a ? a.slice(0,6)+'…'+a.slice(-4) : '—';
    function updatePolistarUI(v){
      document.getElementById('balChip').textContent = 'POLISTAR: '+(v?.toFixed? v.toFixed(0): v);
      document.getElementById('polistarBal').textContent = v;
    }

    // ===== Training drawer logic =====
    const drawer = document.getElementById('drawer');
    const meterBar = document.getElementById('meterBar');
    const progressPct = document.getElementById('progressPct');
    let sessionMs = 30*60*1000; // 30 min default
    let leftMs = sessionMs; let tHandle=null; let activeEmber=null; let started=false;

    function openTraining(emberId){
      activeEmber = emberId; started=false; leftMs=sessionMs; syncTimer();
      document.getElementById('emberName').textContent = emberId ? emberId.toUpperCase() : '—';
      document.getElementById('drawerTitle').textContent = `Training · ${emberId.toUpperCase()}`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
      // TODO: call startEmberTraining (Cloud Function) to validate POLISTAR + open DF CX session
      // await fetch('https://us-central1-poliworld-f165b.cloudfunctions.net/startEmberTraining', {...})
    }

    function startCountdown(){
      if(started) return; started=true; const t0 = Date.now();
      if(tHandle) cancelAnimationFrame(tHandle);
      const loop=()=>{ const now=Date.now(); const dt=now-t0; leftMs = Math.max(0, sessionMs - dt); syncTimer(); if(leftMs>0) tHandle=requestAnimationFrame(loop); };
      requestAnimationFrame(loop);
    }

    function syncTimer(){
      const mm = Math.floor(leftMs/60000).toString().padStart(2,'0');
      const ss = Math.floor((leftMs%60000)/1000).toString().padStart(2,'0');
      document.getElementById('timer').textContent = `00:${mm}:${ss}`;
      const pct = Math.round(100*(1 - leftMs/sessionMs));
      progressPct.textContent = pct+"%"; meterBar.style.width = Math.max(3,pct)+"%";
    }

    // Click handlers for couches
    for(const el of document.querySelectorAll('.couch[data-ember]')){
      el.addEventListener('click', ()=>{ openTraining(el.dataset.ember); startCountdown(); bootChat(); });
    }

    // ===== Chat mock + hooks =====
    const msgs = document.getElementById('msgs');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    function bootChat(){ msgs.innerHTML=''; pushMsg('ember', `Hello Flame. I am ${activeEmber.toUpperCase()} — ready to learn.`); }
    function pushMsg(who, text){
      const m = document.createElement('div'); m.className = 'msg '+(who==='user'?'user':'ember'); m.textContent = text; msgs.appendChild(m); msgs.scrollTop = msgs.scrollHeight;
    }
    async function send(){
      const t = chatInput.value.trim(); if(!t) return; chatInput.value=''; pushMsg('user', t);
      // TODO: send to Dialogflow CX via Cloud Function handleFlameMessage
      // const res = await fetch('https://us-central1-poliworld-f165b.cloudfunctions.net/handleFlameMessage', {...})
      // pushMsg('ember', res.reply)
      setTimeout(()=> pushMsg('ember', 'Noted. I will include this in my teachings.'), 400);
    }
    sendBtn.addEventListener('click', send);
    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

    // Save / End buttons
    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      // TODO: call saveTrainingSummary to: (1) save raw logs to Firestore (2) write summary file to GCS (3) index into DF CX Data Store
      // await fetch('https://us-central1-poliworld-f165b.cloudfunctions.net/saveTrainingSummary', {...})
      alert('Summary saved (stub).');
    });
    document.getElementById('endBtn').addEventListener('click', ()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); });

    // Drag & drop uploader (stubbed)
    const uploader = document.getElementById('uploader');
    ;['dragenter','dragover'].forEach(ev=> uploader.addEventListener(ev, e=>{ e.preventDefault(); uploader.style.background='#0b1320'; }))
    ;['dragleave','drop'].forEach(ev=> uploader.addEventListener(ev, e=>{ e.preventDefault(); uploader.style.background=''; }))
    uploader.addEventListener('drop', async (e)=>{
      const files = Array.from(e.dataTransfer.files || []);
      if(!files.length) return;
      // TODO: stream to GCS signed upload URL from a Cloud Function, then attach to session
      alert(`${files.length} file(s) queued for upload (stub).`);
    });

    // Optional: preselect an Ember on hash
    if(location.hash.startsWith('#train:')){
      const id = location.hash.split(':')[1]; const el = document.querySelector(`.couch[data-ember="${id}"]`); if(el){ el.click(); }
    }
  </script>
</body>
</html>